{% extends 'base.html' %}
{% block content %}

    <!-- Выбор периода -->
    <div style="text-align: center; margin-bottom: 30px;">
        <form method="GET" style="display: inline-block;">
            <select name="period_type" onchange="toggleCustom(this.value)">
                <option value="current_month" {% if period_type == 'current_month' %}selected{% endif %}>Месяц</option>
                <option value="custom" {% if period_type == 'custom' %}selected{% endif %}>Произвольный период</option>
            </select>

            <div id="month-select" style="display: inline-block; margin-left: 10px;">
                <select name="month">
                    {% for m in range(1,13) %}
                        <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
                            {{ ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'][m-1] }}
                        </option>
                    {% endfor %}
                </select>
                <select name="year">
                    {% for y in all_years %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="custom-dates" style="display: none; margin-left: 10px;">
                <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}">
                —
                <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}">
            </div>

            <!-- Фильтр по городу -->
            <label style="margin-left: 20px;"><strong>Город:</strong>
                <select name="city">
                    <option value="all" {% if city_filter == 'all' %}selected{% endif %}>Все города</option>
                    {% for city in all_cities %}
                        <option value="{{ city }}" {% if city_filter == city %}selected{% endif %}>{{ city }}</option>
                    {% endfor %}
                </select>
            </label>

            <button type="submit" style="margin-left: 10px; padding: 8px 16px;">Применить</button>
        </form>
    </div>

    <!-- Заголовок периода -->
    <div style="text-align: center; margin-bottom: 40px;">
        <div style="display: inline-block; background: #f0f0f0; padding: 10px 30px; border-radius: 30px; font-size: 18px;">
            {{ period_label }} {% if city_filter != 'all' %} ({{ city_filter }}){% endif %}
        </div>
    </div>

    <!-- Общая сумма расходов -->
    <div style="text-align: center; margin-bottom: 40px;">
        <div style="display: inline-block; background: #F8F4EE; color: #333 ; padding: 20px 50px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <h2 style="font-size: 48px; margin: 0;">{{ "%.2f"|format(total_expenses) }}$</h2>
            <p style="margin: 10px 0 0; opacity: 0.9;">Общие расходы</p>
        </div>
    </div>

    <!-- Расходы по категориям -->
    <ul>
        {% for et, amount in expense_by_type %}
            <li><strong>{{ et }}:</strong> {{ "%.2f"|format(amount) }} $</li>
        {% else %}
            <li>Пока нет расходов</li>
        {% endfor %}
    </ul>

    <!-- Форма добавления общего расхода -->
    <hr style="margin: 40px 0;">
    <h3>Добавить общий расход (не привязанный к продаже)</h3>
    <form method="POST" action="{{ url_for('add_general_expense') }}">
        <p><label>Тип расхода:<br>
            <select name="expense_type_id" required>
                {% for et in expense_types %}
                    <option value="{{ et.id }}">{{ et.name }}</option>
                {% endfor %}
            </select>
        </label></p>

        <p><label>Сумма:<br>
            <input type="number" step="0.01" name="amount" required>
        </label></p>

        <p><label>Город (опционально):<br>
            <select name="city_id">
                <option value="none">Без города</option>
                {% for city in cities %}
                    <option value="{{ city.id }}">{{ city.name }}</option>
                {% endfor %}
            </select>
        </label></p>

        <p><label>Дата:<br>
            <input type="date" name="date">
        </label> (оставьте пустым для сегодня)</p>


        <p><input type="submit" value="Добавить расход" style="font-size:18px; padding:10px; background:#f44336; color:white; border:none; border-radius:4px;"></p>
    </form>

    <!-- Формы добавления справочников (как в других страницах) -->
    <h3>Добавить новый тип расхода</h3>
    <form method="POST" action="{{ url_for('add_expense_type') }}">
        <input type="text" name="name" required placeholder="Название типа">
        <input type="submit" value="Добавить тип расхода">
    </form>

    <p><a href="{{ url_for('sales') }}">← Вернуться к списку продаж</a></p>

    <script>
        function toggleCustom(val) {
            document.getElementById('month-select').style.display = val === 'current_month' ? 'inline-block' : 'none';
            document.getElementById('custom-dates').style.display = val === 'custom' ? 'inline-block' : 'none';
        }
        toggleCustom('{{ period_type }}');
    </script>
{% endblock %}